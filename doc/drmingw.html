<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>Dr. Mingw</TITLE>
</HEAD>
<BODY>
<H1>Dr. Mingw</H1>
<H2>What is it?</H2>
<p>Dr. Mingw is a <i>Just-in-Time (JIT)</i> debugger. When the application throws 
  an unhandled exception, Dr. Mingw attaches itself to the application and collects 
  information about the exception, using the available debugging information.</p>
<p>Dr. Mingw can read debugging information in <em>Stabs</em> formats &#151; generated 
  by the Gnu C/C++ Compiler, and in a PDB file &#151; generated by the Microsoft 
  Visual C++ Compiler.</p>
<p>Windows NT/2000 platform is supported, as well as Windows 95/98. On older Windows 
  versions though, the IMAGEHLP.DLL isn't included or it's a rather old version. 
  Dr. Mingw doesn't require it, but relies upon it to resolve symbols in modules 
  compiled by the Microsoft tools. See <a href="#imagehlp">The 
  IMAGEHLP.DLL Saga</a> for more information. </p>
<H2>What's new?</H2>
<ul>
  <li>0.1.0
  <ul>
    <li>First release</li>
  </ul>
  </li>
  <li>0.2.0
  <ul>
    <li>fixed the event signaling</li>
    <li>works on the main Windows platforms: 9x, NT and 2k</li>
    <li>GUI</li>
  </ul>
  </li>
  <li>0.2.1
  <ul>
    <li>fixed a bug on the process/thread/module lists</li>
  </ul>
  </li>
  <li>0.3.0
  <ul>
    <li>more efficient and faster stack trace</li>
    <li>support for PDB using ImageHlp API, to trace into C Runtime Library DLLs</li>
    <li>strip long path names</li>
    <li>includes exchndl (former msjexchnd), in a standalone DLL</li>
  </ul>
  </li>
  <li>0.3.1
  <ul>
    <li>better installation procedure</li>
    <ul>
      <li>creates the registry keys whenever they are not present</li>
      <li>the -v option is parsed, regardless of the order</li>
    </ul>
    <li>output is flushed immediately, so if any problem occurs, you still can see what was behind</li>
  </ul>
  </li>
  <li>0.3.2
  <ul>
    <li>fixed some serious bugs originated from code rewrite:</li>
    <ul>
      <li>the stack backtrace would fail if IMAGEHLP.DLL wasn't present</li>
      <li>DrMingw would stop on non NT machines</li>
    </ul>
    <li>IMAGEHLP.DLL is no longer needed for searching the nearest exported symbol in modules without debugging information</li>
    <li>the -d option was removed, now it's -v only</li>
  </ul>
  </li>
  <li>0.4.0
  <ul>
    <li>dumps arguments of function calls</li>
  </ul>
  </li>
  <li>0.4.1
  <ul>
    <li>more flexible GUI</li>
  </ul>
  </li>
  <li>0.4.2
  <ul>
    <li>a nicer format of the arguments dump</li>
  </ul>
  </li>
  <li>0.4.3
  <ul>
    <li>fixed a bug that could prevent of working on some releases of Windows NT4</li>
    <li>added a new way to trace source lines using the Stabs debugging information (especially useful with inline members of C++ classes)</li>
  </ul>
  </li>
</ul>
<H2>Download</H2>
<p>Download <A href="ftp://ftp.fe.up.pt/pub/Projectos/em96115/gnu-win32/misc/drmingw-0.4.3.tar.bz2">here</A> the lastest binaries and source code. It's in .tar.bz2 format. You can use this very 
  small (23 kb) standalone decompressor, <a href="ftp://ftp.fe.up.pt/pub/Projectos/em96115/misc/untbz2.exe">untbz2</a>. 
  For more information about bzip2 see its <a href="http://sourceware.cygnus.com/bzip2"> 
  homepage</a>.</p>
<H2>Installation</H2>
<p>To install enter</p>
<blockquote> 
  <pre><b>drmingw -i</b></pre>
</blockquote>
<p>Dr. Mingw will register itself as the JIT debugger by writting into the system 
  registry. On Windows NT/2000 make sure you have Administrator rights. See <a href="#jit">Enabling 
  Just-in-Time (JIT) Debugging</a> for more information.</p>
<H2></H2>
<p>If the installation is sucessful, the following message box should appear:</p>
<p align="center"><img src="install.gif"></p>
<p>To enable other options they must be set them allong with the <b>-i</b> option. 
  For example,</p>
<blockquote>
  <pre><b>drmingw -i -v </b></pre>
</blockquote>
<p>If you still have trouble installing, edit the included<b> drmingw.reg</b> 
  file to reflect the <b>drmingw.exe</b> executable path and load it on the system 
  registry.</p>
<H2>Using</H2>
<p>You can test Dr. Mingw by running the sample<b> test.exe</b>.</p>
<p>Depending of your Windows version, you'll see a familiar dialog:</p>
<p align="center"><img src="exception-nt.gif"></p>
<p>If you request to debug the program, Dr. Mingw will attach to the faulting 
  application, collect information about the exception, and display the dialog</p>
<p align="center"><img src="sample.gif"></p>
<p>To resolve the addresses it's necessary to compile the application with debugging 
  information. In case of address is in a DLL with no debugging information, it 
  will resolve to the precedent exported symbol.</p>
<H2>Command Line Options</H2>
<p>The Dr. Mingw command line uses the following syntax:</p>
<pre><b>drmingw </b>[<b>-h | --help</b>] [<b>-V | --version</b>] [<b>-i | --install</b>] [<b>-a | --auto</b>] [<b>-u | --uninstall</b>]
[<b>-p</b> <i>pid</i> | <b>--process-id=</b><i>pid</i>]  [<b>-e</b> <i>event</i> | <b>--event=</b><i>event</i>]
[<b>-v | --verbose</b>]
</pre>
<p>The following table describes the Dr. Mingw command-line options. All comand-line 
  options are case-sensitive. </p>
<table width="78%">
  <tr valign="top"> 
    <th align=left width=10%>Option</th>
    <th align=left width=25%>&nbsp;</th>
    <th align=left width=65%>Action</th>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-h</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--help</b></pre>
    </td>
    <td width=65%>Print help and exit </td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-V</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--version</b></pre>
    </td>
    <td width=65%>Print version and exit</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-i</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--install</b></pre>
    </td>
    <td width=65%>Install as the default JIT debugger</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-a</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--auto</b></pre>
    </td>
    <td width=65%>Automatically start (used with <b>-i</b> | <b>--install</b>)</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-u</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--uninstall</b></pre>
    </td>
    <td width=65%>Uninstall</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-p</b> <i>pid</i></pre>
    </td>
    <td width=25%> 
      <pre><b>--process-id=</b><i>pid</i></pre>
    </td>
    <td width=65%>Attach to the process with the given identifier</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-e</b> <i>event</i></pre>
    </td>
    <td width=25%> 
      <pre><b>--event=</b><i>event</i></pre>
    </td>
    <td width=65%>Signal an event after process is attached</td>
  </tr>
  <tr valign="top"> 
    <td width=10%> 
      <pre><b>-v</b></pre>
    </td>
    <td width=25%> 
      <pre><b>--verbose</b></pre>
    </td>
    <td width=65%>Verbose output</td>
  </tr>
</table>
<H2><a name="exchndl"></a>The EXCHNDL.DLL</H2>
<H3>Introduction</H3>
<p>Although internally Dr. Mingw behaves much like a debugger, from the outside 
  it is like a standalone exception handler. But for its own debugging purposes, 
  Dr. Mingw has a internal exception handler that is completly seperate from the 
  main code.</p>
<p>This exception handler resides in <b>exchndl.c</b>. When <b>drmingw.exe</b> 
  is loaded, the code in <b>exchndl.c</b> is automatically executed (by the 
  gcc static constructor/destructor mechanism) and registers itself as a exception 
  handler.</p>
<p>This exception handler is much lighter than Dr. Mingw debugging system because 
  it doesn't have to deal with interprocess communication. The exception handling 
  routine runs in the same process context of the faulting application (<b>drmingw</b>, 
  in this case).</p>
<H3>Using ExcHndl for you own purposes</H3>
<p>If you incorporate ExcHndl in you own programs, especially those that you release 
  to others, you can have almost the same exception information that you would 
  get with Dr. Mingw, but with no need of the end user to have Dr. Mingw installed.</p>
<p>You can use ExcHndl in two ways:</p>
<ul>
  <li>linking <b>exchndl.o</b> and <b>libbfd.a</b> with your program objects</li>
  <li>linking <b>exchndl.o</b> and <b>libfd.a</b> in the <b>EXCHNDL.DLL</b> and 
    dinamically loading it at run-time. This can be done by linking just <b>exchndl2.o</b> 
    or explicitly calling <i>LoadLibrary(&quot;exchndl.dll&quot;)</i></li>
</ul>
<p>The latter method is preferred because you have smaller executables and don't 
  need to link the BFD library in all builds. The application wont fail if the 
  <b>EXCHNDL.DLL</b> is missing.</p>
<H3>Example</H3>
<p>The sample<b> test.exe</b> application uses the second method above. Copy <b>EXCHNDL.DLL</b> 
  to executable directory. When you run it, even before general protection fault 
  dialog box appears, it's written to the <b>test.RPT</b> file a report of the 
  fault.</p>
<p>Here is how <b>test.RPT</b> should look like:</p>
<pre>-------------------

Error occured on Sunday, May 7, 2000 at 20:22:03.

C:\home\jrfonseca\drmingw\src\test.exe caused an Access Violation in module C:\WINDOWS\system32\msvcrt.dll Writing to location 00000008.

Registers:
eax=00003039 ebx=00000064 ecx=00000008 edx=0244fec0 esi=00401211 edi=0244fec0
eip=78027470 esp=0244fcd8 ebp=0244fea8 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00010202

Call stack:
78027470  C:\WINDOWS\system32\msvcrt.dll:78027470  wscanf
7802544B  C:\WINDOWS\system32\msvcrt.dll:7802544B  sscanf
00401241  C:\home\jrfonseca\drmingw\src\test.exe:00401241  YetAnotherFunction  //C/home/jrfonseca/drmingw/src/test.cxx:14
00401272  C:\home\jrfonseca\drmingw\src\test.exe:00401272  MyWonderfulFunction  //C/home/jrfonseca/drmingw/src/test.cxx:19
004012A9  C:\home\jrfonseca\drmingw\src\test.exe:004012A9  main  //C/home/jrfonseca/drmingw/src/test.cxx:24
004011C1  C:\home\jrfonseca\drmingw\src\test.exe:004011C1
004011EB  C:\home\jrfonseca\drmingw\src\test.exe:004011EB
77E87903  C:\WINDOWS\system32\KERNEL32.dll:77E87903  SetUnhandledExceptionFilter


</pre>
<H2>Appendix</H2>
<H3><a name="jit"></a>Enabling Just-in-Time (JIT) Debugging</H3>

<P><span style="color:#FF0000">[Taken from Using Microsoft Debuggers of the April 
  2000 Platform SDK.]</span> </P>

<P>There are a variety of application errors which will cause Windows NT/Windows&nbsp;2000 a to terminate the application. The most common kinds of errors are deadlocks and access violations. From the operating systems point of view, these are all simply unhandled exceptions.</P>

<P>When an application error occurs, Windows searches for an exception handler. If it does not find an exception handler, the system verifies that the application is not currently being debugged and considers the exception to be unhandled. At this point, there are three possible responses:

<UL>
	<LI>Windows can end the process immediately.</LI>

	<LI>Windows can freeze the process and start a user-mode debugger. This debugger can then be used to examine the application.</LI>

	<LI>Windows can run a debugging tool which will create a memory dump file of the application's memory space, and then end the process.</LI>
</UL>

<P>The debugging tool which is used to debug the application or write the dump file is called <I>Just-in-Time (JIT) Debugger</I>, or the <I>post-mortem debugger</I>.</P>

<P>The default JIT debugger is Dr.&nbsp;Watson. When the application throws an 
  unhandled exception, Dr. Watson attaches itself to the application and generates 
  a crash dump file. After it creates the crash dump file, Dr. Watson closes the 
  application and exits.</P>

<P>Any user-mode debugging tool can be selected as the JIT debugger:

<UL>
	
  <LI>To change the JIT debugger to WinDbg, run <B>windbg&nbsp;-I</B>. When WinDbg 
    is the JIT debugger, WinDbg will be activated whenever an application crashes. 
    See WinDbg Command Line Options for details.</LI>

	<LI>To change the JIT debugger to NTSD, you must edit the registry.  When NTSD is the JIT debugger, NTSD will be activated whenever an application crashes.</LI>

	
  <LI>To change the JIT debugger back to Dr.&nbsp;Watson, run <B>drwtsn32&nbsp;-i</B>. 
    When Dr.&nbsp;Watson is the JIT debugger, a memory dump file will be written 
    to disk if an application crashes. See Dr. Watson Command Line Options for 
    details.</LI>
</UL>

<P>Only a system administrator can alter the JIT settings.</P>

<P>If a JIT debugger has been installed, you can deliberately break into the debugger from a user-mode application by calling the <B>DebugBreak</B> function.</P>

<H4>Editing the Registry</H4>

<P>The Just-in-Time debugging settings are stored in the registry, under <B>\\HKEY_LOCAL_MACHINE\Software\Microsoft\Windows&nbsp;NT\CurrentVersion\AeDebug\</B>. The two relevant keys in this directory are <B>Debugger</B> and <B>Auto</B>.</P>

<P>The <B>Debugger</B> key's value shows the name of the debugger specified to analyze application errors. The <B>Auto</B> key is either zero or one.</P>

<P>When an unhandled application error occurs, Windows checks to see if the <B>Debugger</B> and <B>Auto</B> keys exist.</P>

<P>If the <B>Auto</B> key equals zero and the <B>Debugger</B> value contains the name of a valid debugger (such as WinDbg or NTSD), the message box will have two buttons: <B>OK</B> and <B>Cancel</B>. If the <B>OK</B> button is pressed, the application is terminated. If the <B>Cancel</B> button is pressed, the debugger specified in the <B>Debugger</B> key is started.</P>

<P>If the <B>Auto</B> key equals zero, but the <B>Debugger</B> key value is empty, the message box will have only an <B>OK</B> button and no debugger will start.</P>

<P>If the <B>Auto</B> key equals one, no message box appears. The debugger referred to in the <B>Debugger</B> key is automatically started.</P>

<P><B>Setting Dr. Watson as the JIT debugger (default):</B></P>

<PRE>Debugger = "drwtsn32 -p %ld -e %ld -g"
Auto = 1</PRE>

<P><B>Setting WinDbg as the JIT debugger:</B></P>

<PRE>Debugger = "WinDbg -p %ld -e %ld"
Auto = 1</PRE>

<P><B>Setting NTSD as the JIT debugger:</B></P>

<PRE>Debugger = "NTSD -p %ld -e %ld -g"
Auto = 1</PRE>

<P>In these examples, -<B>p&nbsp;%ld</B> specifies the process ID that NTSD will debug, -<B>e&nbsp;%ld</B> provides the event that caused the exception, and -<B>g</B> causes the debugger to skip the initial breakpoint. (Dr.&nbsp;Watson ignores the -<B>g</B> option.)</P>
<DIV CLASS="footer"> 
  <p>Built on Thursday, April 20, 2000</p>
  <H3><a name="imagehlp"></a>The IMAGEHLP.DLL Saga</H3>
  <p><span style="color:#FF0000">[Taken from several Bugslayer articles of MSJ.]</span> 
  </p>
  <p>The IMAGEHLP.DLL symbol engine first appeared in Windows NT® 4.0. The beta 
    Windows NT 5.0 SDK had new parts of IMAGEHLP.H that dealt with source and 
    line information. In the meantime, the November 1998 Platform SDK showed and 
    the IMAGEHLP.DLL that shipped with it supported the new source and line handling. 
    There are several different versions of IMAGEHLP.DLL. The only one that does 
    not support the new source and line information is the original Windows NT 
    4.0 version. </p>
  <p>The IMAGEHLP.DLL version 5.00.1678.1 dynamically links to MSPDB50.DLL. It 
    first tries to load MSDBI.DLL, and if that is not found it will load MSPDB50.DLL, 
    so it works with both Visual C++® 5.0 and 6.0. To use it with Visual C++ 6.0, 
    copy MSPDB50.DLL to MSPDB60.DLL. If you want to get symbols from the field, 
    you will have to compile with CodeView® symbols and use .DBG files to get 
    them. Keep in mind that MSPDB50.DLL, like MSDBI.DLL, is not redistributable. 
  </p>
  <p>The IMAGEHLP.DLL version 5.00.1878.1, which comes with the Windows 2000 Beta 
    2 Platform SDK, hard links against MSDBI.DLL — instead of dynamically loading 
    MSPDB50.DLL as in earlier versions— to read PDB files. The problem is that 
    MSDBI.DLL is not redistributable.</p>
  <p> IMAGEHLP.DLL now uses DEBUGHLP.DLL. </p>
  <p>If you want IMAGEHLP.DLL, it's available in:</p>
</DIV>
<ul>
  <li> 
    <DIV CLASS="footer">Platform SDK</DIV>
  </li>
  <li> 
    <DIV CLASS="footer">WinDBG Debugger</DIV>
  </li>
  <li> 
    <DIV CLASS="footer">Windows 2000</DIV>
  </li>
</ul>
<DIV CLASS="footer">
  <H2>Suggested Reading</H2>
</DIV>
<ul>
  <li> 
    <DIV CLASS="footer"><a href="http://www.microsoft.com/msj/0197/exception/exception.htm">A 
      Crash Course on the Depths of Win32 Structured Exception Handling, MSJ January 
      1997</a></DIV>
  </li>
  <li> 
    <DIV CLASS="footer"><a href="http://www.microsoft.com/msj/0497/hood/hood0497.htm">MSJEXHND 
      - Part 1, Under the Hood, MSJ April 1997</a></DIV>
  </li>
  <li> 
    <DIV CLASS="footer"><a href="http://www.microsoft.com/msj/0597/hood/hood0597.htm">MSJEXHND 
      - Part 2, Under the Hood, MSJ May 1997</a></DIV>
  </li>
  <li><a href=http://www.microsoft.com/msj/0898/bugslayer0898.htm>Bugslayer, MSJ, 
    August 1998</a></li>
  <li> 
    <DIV CLASS="footer"><a href="http://msdn.microsoft.com/library/techart/msdn_debug.htm">
    The Win32 Debugging Application Programming Interface</a></DIV>
  </li>
</ul>
<H2>Contact</H2>
<p>José Fonseca</p>
<p><a href="mailto:em96115@fe.up.pt">em96115@fe.up.pt</a></p>
<p><a href="http://www.fe.up.pt/~em96115/gnu-win32">http://www.fe.up.pt/~em96115/gnu-win32</a></p>
<DIV CLASS="footer">
  <p>&nbsp;</p>
</DIV>

</BODY>
</HTML>
